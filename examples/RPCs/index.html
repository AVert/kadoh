<html>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script type="text/javascript" src="/dist/KadOH.js"></script>

<script type="text/javascript">
$(function() {
  var KadOH = window.KadOH;
  var udp = new window.KadOH.transport.SimUDP('localhost');
  
  // Init the node global object
  function init(ip_port) {
    node = new KadOH.Node(undefined);
    console.log('ME :' + node.getAddress());
  }
  
  // Join the network using other clients as bootstraps
  function onClickJoin(event) {
    var bootstraps = [];
    for (ip in ips) {
      if (KadOH.globals._digest(ip) !== node.getID()) {
        bootstraps.push(ip);
      }
    }
    
    // keep only some boostraps
    var number_of_bootstraps = 1;
    bootstraps.splice(0, bootstraps.length - number_of_bootstraps);
    
    try {
      node.join(bootstraps).then(
        function(new_nodes) {
          console.log(new_nodes);
        }
      );
    }
    catch(e) {
      console.log(e);
    }
    event.preventDefault();
  }
  
  // Send a ping
  function onClickPing(event) {
    var dst = $('#form [name=dest]').val(); // IP:PORT
    try {
      node._reactor.PING(dst).then(
        function(pong) {
          $('#received').append('<p><b>' + pong + '</b></p>');
        },
        function(err) {
          $('#received').append('<p><b>' + err + '</b></p>');
        }
      );
    }
    catch(e) {
      console.log(e);
    }
    
    event.preventDefault();
  }
  
  // Update window.ips list
  function onNewClient(msg) {
    ips = msg;
    
    $('#form select').empty();
    for (ip in msg) {
      $('#form select').append('<option value="' + ip + '">' + ip + '</option>');
    }
    // append a fake node
    $('#form select').append('<option value="127.0.0.1:33445">FAKE</option>')
  }
  
  // Init the node when receiving our ip and port
  udp._whoami(init);
  udp.socket.on('clients-up', onNewClient);
  $('#join').click(onClickJoin);
  $('#ping').click(onClickPing);
});
</script>
<body>
<h2>Send message to node :</h2>
<form id='form'>
  <p>
    <input type="submit" value="Join" name="join" id="join">
  </p>
  <p>
    <select name="dest">
    </select>
    <input type="submit" value="Ping" name="ping" id="ping">
  </p>
</form>
<h2>Messages received :</h2>
<div id='received'></div>
</body>
</html>
