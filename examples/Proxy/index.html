<html>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script type="text/javascript" src="/dist/KadOH.js"></script>

<script type="text/javascript">
$(function() {
  var KadOH = window.KadOH;
  var udp = new window.KadOH.transport.SimUDP('localhost');
  
  // Init the node global object
  function init(ip_port) {
    var ip_port = ip_port.split(':');
    
    node = new KadOH.Node(ip_port[0], ip_port[1]);
    console.log('ME :', node.getSocket());
    console.log(node.getId());
  }
  
  // Join the network using other clients as bootstraps
  function onClickJoin(event) {
    try {
      var bootstraps = [['router.utorrent.com', 6881], ['router.bittorrent.com', 6881]];
      var it = node.join(bootstraps)
      it.then(
        function(response) {
          console.log(response.map(function(peer) {
            return peer.getSocket() + ' : ' + peer.getId() + ' : ' + node._routing_table.distance(peer.getId());
          }));
        });
      it.on('Reached', function(fromPeer, response) {
        var response = response.map(function(peer) {
            return peer.getSocket() +'('+ node._routing_table.distance(peer.getId())+')';
          });
        console.log('Reached : '+fromPeer.getSocket()+'('+fromPeer._distance+') and return : '+response.join(' '));
      });
      it.on('NotReached', function(fromPeer) {
        console.log('NotReached :'+fromPeer.getSocket());
      });
      it.on('newHeardOf', function(p) {
        var p = p.map(function(peer) {
            return peer.getSocket() +'(' +node._routing_table.distance(peer.getId())+')';
          });
        console.log('newHeardOf : '+p.join(' '));
      });
    }
    catch(e) {
      console.error(e);
    }
    event.preventDefault();
  }
  
  function onClickLookup(event) {
    try {
      node.iterativeFindNode(node.getId()).then(
        function(response) {
          console.log(response.map(function(peer) {
            return peer.getSocket() + ' : ' + peer.getId() + ' : ' + node._routing_table.distance(peer.getId());
          }));
        }
      );
    }
    catch(e) {
      console.error(e);
    }
    event.preventDefault();
  }

  function onClickFind(event) {
    try {
      var key = $('#key').val().toString();
      var dst = new Peer($('#dst').val().toString());
      node.reactor().FIND_NODE(dst, key).then(
        function(result) {
          node._routing_table.addPeers(result);
          console.log(result);
        },
        function(result) {
          console.log("impossible to finish");
        }
      );
    }
    catch(e) {
      console.error(e);
    }
    event.preventDefault();
  }

  // Init the node when receiving our ip and port
  udp._whoami(init);
  $('#join').click(onClickJoin);
  $('#lookup').click(onClickLookup);
  $('#find').click(onClickFind);
});
</script>
<body>
<h2>Send message to node :</h2>
<form id='form'>
  <p>
    <input type="submit" value="Join" name="join" id="join">
  </p>
  <p>
    <input type="submit" value="Iterative Lookup" name="lookup" id="lookup">
  </p>
  <p>
    <input type="text" value="" id="dst">
    <input type="text" value="" id="key">
    <input type="submit" value="FIND_NODE" name="find" id="find">
  </p>
</form>
<h2>Messages received :</h2>
<div id='received'></div>
</body>
</html>
