#!/usr/bin/env node

//
// Bot CLI
//

var Bot = require(__dirname + '/../bot.js').Bot;

var argv  = require('optimist')
            .usage('Usage: $0 -j foo@bar -r kadoh -p azerty -d [num]')
            .alias('j', 'jid')
            .alias('r', 'resource')
            .alias('p', 'password')
            .alias('d', 'delay')
            .argv;

var debug     = !!argv.debug,
    name      = argv.udp ? 'udpbot'   : 'xmppbot',
    protocol  = argv.udp ? 'jsonrpc2' : 'node_xmlrpc',
    type      = argv.udp ? 'UDP'      : 'NodeXMPP',
    delay     = argv.delay || 0,
    transport = {
      jid      : argv.jid,
      resource : argv.resource,
      password : argv.password,
      port     : argv.port
    };

var config = {
  hook : {
    name   : name,
    silent : true
  },
  node : {
    reactor : {
      protocol  : protocol,
      type      : type,
      transport : transport
    }
  },
  delay : delay
};

var bot = new Bot(config);
bot.start();

if (debug) {
  bot.on('hook::ready', function() {
    KadOH.log.setLevel('debug');
    KadOH.log.subscribeTo(bot.kadoh);
    KadOH.log.subscribeTo(bot.kadoh._reactor);
    KadOH.log.subscribeTo(bot.kadoh._reactor._transport);
  });
}

if (argv.cli) {
  require('repl').start('> ').context.node = bot.kadoh;
}