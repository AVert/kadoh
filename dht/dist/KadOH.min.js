global._k=6,global._alpha=3,global._B=160,global._digest=Crypto.digest.SHA1
var Node=Class.create({initialize:function(a,b,c){typeof c=="undefined"?this.id=this._generateId():this.id=c,this._routing_table=new RoutingTable(this.id)},_generateId:function(){return _digest(this.ip+":"+this.port)}})
var RoutingTable=Class.create({initialize:function(a){this._parent_id=a,this._kbuckets=[new KBucket(0,_B-1)]},distance:function(a){return Crypto.util.distance(this._parent_id,a)},addPeer:function(a){if(a.id==this._parent_id)return;try{var b=this._kbucketFor(a.id)}catch(c){}},getPeer:function(a){var b=this._kbucketFor(a).getPeer(a);return b?b:!1},removePeer:function(a){return typeof a=="object"&&(a=a.getId()),this._kbucketFor(a).removePeer(a)},_kbucketIndexFor:function(a){dist=this.distance(a);for(kbucket in this._kbuckets)if(this._kbuckets[kbucket].distanceInRange(dist))return kbucket;return!1},_kbucketFor:function(a){var b=this._keybucketIndexFor(a);return b?this._kbuckets[b]:!1}})
var KBucket=Class.create({initialize:function(a,b){this._min=typeof a=="undefined"?0:a,this._max=typeof b=="undefined"?_B-1:b,this._size=0,this._peers_ids=[],this._peers={}},addPeer:function(a){var b=this._peerExists(a);if(b!=0)delete this._peer_ids[b.index],this._size=this._peer_ids.unshift(a.getId());else if(this._size<_k)this._peers[a.id]=a,this._size=this._peers_ids.unshift(a.id);else throw console.error("The kbucket "+this.toString()+"is full"),new Error("FULL")},getPeer:function(a){var b=this._peerExists(a);return b===!1?!1:this._peers[b.id]},getPeers:function(a){a=Math.max(0,Math.min(a,this._size))},removePeer:function(a){var b=this._peerExists(a);return b===!1?!1:(delete this._peers_ids[b.index],delete this._peers[b.id],!0)},idInRange:function(a){},distanceInRange:function(a){return this._min<=a&&a<this._max},toString:function(){return"<"+this._min+":"+this._max+">"},_peerExists:function(a){var b,c;return typeof a=="object"?(b=a.getId(),c=this._peers_ids.indexOf(b)):(b=a,c=this._peers_ids.indexOf(a)),c===-1?!1:{index:c,id:b}}})
var Peer=Class.create({initialize:function(a,b,c){this._ip=a,this._port=b,this._socket=a+":"+b,typeof c=="undefined"?this._id=this._generateId():this._id=c},getId:function(){return this._id},getSocket:function(){return this._socket},toString:function(){return"<"+this._id+"; "+this._socket+">"},_generateId:function(){return _digest(this._socket)}})