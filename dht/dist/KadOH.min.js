global._k=6,global._alpha=3,global._B=160,global._digest=Crypto.digest.SHA1
(function(a){var b=a;b.core={},b.core.Class=function(){function f(a){return j.call(g(a)?a:function(){},a,1)}function g(a){return typeof a===c}function h(a,b,c){return function(){var d=this.supr;this.supr=c[e][a];var f=b.apply(this,arguments);return this.supr=d,f}}function i(a,b,c){for(var f in b)b.hasOwnProperty(f)&&(a[f]=g(b[f])&&g(c[e][f])&&d.test(b[f])?h(f,b[f],c):b[f])}function j(a,b){function c(){}function l(){this.initialize?this.initialize.apply(this,arguments):(b||h&&d.apply(this,arguments),j.apply(this,arguments))}c[e]=this[e];var d=this,f=new c,h=g(a),j=h?a:this,k=h?{}:a;return l.methods=function(a){return i(f,a,d),l[e]=f,this},l.methods.call(l,k).prototype.constructor=l,l.extend=arguments.callee,l[e].implement=l.statics=function(a,b){return a=typeof a=="string"?function(){var c={};return c[a]=b,c}():a,i(this,a,d),this},l}var a=this,b=a.klass,c="function",d=/xyz/.test(function(){xyz})?/\bsupr\b/:/.*/,e="prototype";return f.noConflict=function(){return a.klass=b,this},a.klass=f,f}()})("object"==typeof module?module.exports:this.KadOH={})
var Crypto=global.Crypto={},util=Crypto.util={rotl:function(a,b){return a<<b|a>>>32-b},rotr:function(a,b){return a<<32-b|a>>>b},endian:function(a){if(a.constructor==Number)return util.rotl(a,8)&16711935|util.rotl(a,24)&4278255360;for(var b=0;b<a.length;b++)a[b]=util.endian(a[b]);return a},randomBytes:function(a){for(var b=[];a>0;a--)b.push(Math.floor(Math.random()*256));return b},bytesToWords:function(a){for(var b=[],c=0,d=0;c<a.length;c++,d+=8)b[d>>>5]|=a[c]<<24-d%32;return b},wordsToBytes:function(a){for(var b=[],c=0;c<a.length*32;c+=8)b.push(a[c>>>5]>>>24-c%32&255);return b},bytesToHex:function(a){for(var b=[],c=0;c<a.length;c++)b.push((a[c]>>>4).toString(16)),b.push((a[c]&15).toString(16));return b.join("")},hexToBytes:function(a){for(var b=[],c=0;c<a.length;c+=2)b.push(parseInt(a.substr(c,2),16));return b},XOR:function(a,b){if(a.length!=b.length)return;a=util.hexToBytes(a),b=util.hexToBytes(b);var c=[];for(var d=0;d<key1.length;d++)c.push(key1[d]^key2[d]);return c},distance:function(a,b){if(a===b)return 0;a=Crypto.util.hexToBytes(a),b=Crypto.util.hexToBytes(b);var c=a.length;if(c!=b.length)return console.error("distance between two different sized key"),-1;var d=c*8-1;for(i=0;i<c;i++){var e=a[i]^b[i];if(e){for(var f=0;f<7;f++)if(e>>>7-f)break;return d-i*8-f}}return d}},charenc=Crypto.charenc={},Binary=Crypto.charenc.Binary={stringToBytes:function(a){for(var b=[],c=0;c<a.length;c++)b.push(a.charCodeAt(c)&255);return b},bytesToString:function(a){for(var b=[],c=0;c<a.length;c++)b.push(String.fromCharCode(a[c]));return b.join("")}},UTF8=Crypto.charenc.UTF8={stringToBytes:function(a){return Binary.stringToBytes(unescape(encodeURIComponent(a)))},bytesToString:function(a){return decodeURIComponent(escape(Binary.bytesToString(a)))}},digest=Crypto.digest={SHA1:function(a,b){var c=util.wordsToBytes(digest._sha1(a));return b&&b.asBytes?c:b&&b.asString?Binary.bytesToString(c):util.bytesToHex(c)},_sha1:function(a){a.constructor==String&&(a=UTF8.stringToBytes(a));var b=util.bytesToWords(a),c=a.length*8,d=[],e=1732584193,f=-271733879,g=-1732584194,h=271733878,i=-1009589776;b[c>>5]|=128<<24-c%32,b[(c+64>>>9<<4)+15]=c;for(var j=0;j<b.length;j+=16){var k=e,l=f,m=g,n=h,o=i;for(var p=0;p<80;p++){if(p<16)d[p]=b[j+p];else{var q=d[p-3]^d[p-8]^d[p-14]^d[p-16];d[p]=q<<1|q>>>31}var r=(e<<5|e>>>27)+i+(d[p]>>>0)+(p<20?(f&g|~f&h)+1518500249:p<40?(f^g^h)+1859775393:p<60?(f&g|f&h|g&h)-1894007588:(f^g^h)-899497514);i=h,h=g,g=f<<30|f>>>2,f=e,e=r}e+=k,f+=l,g+=m,h+=n,i+=o}return[e,f,g,h,i]},_blocksize:16,_digestsize:20}
var Node=Class.create({initialize:function(a,b,c){typeof c=="undefined"?this.id=this._generateId():this.id=c,this._routing_table=new RoutingTable(this.id)},_generateId:function(){return _digest(this.ip+":"+this.port)}})
var RoutingTable=Class.create({initialize:function(a){this._parent_id=a,this._kbuckets=[new KBucket(0,_B-1,a)]},distance:function(a){return Crypto.util.distance(this._parent_id,a)},addPeer:function(a){if(a.id==this._parent_id)return;try{var b=this._kbucketIndexFor(a.id),c=this._kbuckets[b];if(c.isSplittable()){var d=c.split();d.addPeer(a),this._kbuckets.splice(b+1,0,d)}}catch(e){}},getPeer:function(a){var b=this._kbucketFor(a).getPeer(a);return b?b:!1},removePeer:function(a){return typeof a=="object"&&(a=a.getId()),this._kbucketFor(a).removePeer(a)},_kbucketIndexFor:function(a){dist=this.distance(a);for(var b=0;b<this._kbuckets.length;b++)if(this._kbuckets[b].distanceInRange(dist))return b;return!1},_kbucketFor:function(a){var b=this._keybucketIndexFor(a);return b?this._kbuckets[b]:!1}})
var KBucket=Class.create({initialize:function(a,b,c){this._min=typeof a=="undefined"?0:a,this._max=typeof b=="undefined"?_B-1:b,this._parent_id=c,this._size=0,this._distances=[],this._peers_ids=[],this._peers={}},addPeer:function(a){var b=this._peerExists(a);if(b!=0)this._updatePeer(a.getId());else if(this._size<_k)this._appendPeer(a);else throw console.error("The kbucket "+this.toString()+"is full"),new Error("FULL")},getPeer:function(a){var b=this._peerExists(a);return b===!1?!1:this._peers[b.id]},getPeers:function(a){if(typeof a=="undefined")return this._peers;a=Math.max(0,Math.min(a,this._size));var b=[],c=0,d=0;for(c=0;c<this._size;c++){if(d>=a)break;b.push(this._peers[c]),d++}return b},removePeer:function(a){var b=this._peerExists(a);return b===!1?!1:(delete this._peers_ids[b.index],delete this._peers[b.id],this._size=this._peers_ids.length,!0)},idInRange:function(a,b){return this.distanceInRange(Crypto.util.distance(a,b))},distanceInRange:function(a){return this._min<=a&&a<this._max},getRange:function(){return{min:this._min,max:this._max}},setRange:function(a){this._min=a.min,this._max=a.max},setRangeMin:function(a){this._min=a},setRangeMax:function(a){this._max=a},split:function(){var a=(this._min+this._max)/2,b=new KBucket(a,this._max,this._parent_id);this.setRangeMax(a);var c;for(var c=0;c<this._size;c++){var d=this._peers_ids[c],e=this._peers[d],f=this._distances[d];b.distanceInRange(f)&&(b.addPeer(e),this.removePeer(e))}return b},isSplittable:function(){return this.idInRange(this._parent_id)},toString:function(){return"<"+this._min+":"+this._max+"><#"+this._size+">"},_updatePeer:function(a){delete this._peer_ids[tuple.index],this._size=this._peer_ids.unshift(peer.getId())},_appendPeer:function(a){var b=a.getId();this._peers[b]=a,this._size=this._peers_ids.unshift(b),this._distances[b]=Crypto.util.distance(b,this._parent_id)},_peerExists:function(a){var b,c;return typeof a=="object"?(b=a.getId(),c=this._peers_ids.indexOf(b)):(b=a,c=this._peers_ids.indexOf(a)),c===-1?!1:{index:c,id:b}}})
var Peer=Class.create({initialize:function(a,b,c){this._ip=a,this._port=b,this._socket=a+":"+b,typeof c=="undefined"?this._id=this._generateId():this._id=c},getId:function(){return this._id},getSocket:function(){return this._socket},toString:function(){return"<"+this._id+"; "+this._socket+">"},_generateId:function(){return _digest(this._socket)}})