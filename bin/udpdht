#!/usr/bin/env node

//
// Configurations
//
var size       = parseInt(process.argv[2], 10) || 10;
var bootstraps = ["127.0.0.1:3000", "127.0.0.1:3001", "127.0.0.1:3002"];
var activity   = 200 / size;
var values     = 10000;
var port       = 10000;

var spawn = require("child_process").spawn;

var BOTS_PATH = __dirname + "/../bots/bin";
var BBIN = BOTS_PATH + "/bootstrap";
var PBIN = BOTS_PATH + "/pool";

function launchPools() {
  var pproc = spawn("node", [
    PBIN,
    "--udp",
    "--port="       + port,
    "--size="       + size,
    "--bootstraps=" + bootstraps.join(','),
    "--activity="   + activity,
    "--values="     + values
  ]);
  pproc.stdout.on('data', function(data) {
    process.stdout.write(String(data));
  });
  pproc.stderr.on('data', function(data) {
    process.stderr.write(String(data));
  });
}

var connected = 0;
bootstraps.forEach(function(bootstrap) {
  var port = bootstrap.split(":")[1];
  bproc = spawn("node", [
    BBIN,
    "--udp",
    "--port=" + port
  ]);
  bproc.stdout.on('data', function(data) {
    if (/connected/.test(data)) {
      if (++connected === bootstraps.length) {
        launchPools();
      }
    }
  });
  bproc.stderr.on('data', function(data) {
    process.stderr.write(String(data));
  });
});
